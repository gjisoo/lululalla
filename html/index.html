<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>바톤터치: Ant Tap Sprint</title>
<style>
  html,body{margin:0;height:100%;background:#0e0a0a;touch-action:none;-webkit-user-select:none;user-select:none}
  #wrap{position:fixed;inset:0;display:grid;place-items:center;margin: 0 auto;} /* 중앙 정렬을 보장 */
  canvas{background:#120d0d;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.6);image-rendering:pixelated;margin: 0 auto;max-width: 100%;max-height: 100%;} /* 추가: 중앙 정렬 */
  .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#ffdca8;font:600 16px ui-rounded,system-ui;text-shadow:0 2px 0 #000;display:flex;gap:14px}
  .meter{position:fixed;top:42px;left:50%;transform:translateX(-50%);width:70vw;max-width:460px;height:10px;background:#3a2b22;border-radius:999px;overflow:hidden}
  .meter>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ffe39f,#ffc857)}
  .btnpad{position:fixed;inset:auto 0 0 0;display:flex;gap:8px;padding:10px}
  .tap{flex:1;height:32vh;min-height:160px;border:none;border-radius:16px;background:rgba(255,255,255,.06);color:#ffdca8;font:800 18px/1 system-ui}
  .tap:active{background:rgba(255,255,255,.12)}
  #result{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6)}
  #card{background:#241712;color:#ffdca8;border:1px solid #5a4537;border-radius:14px;padding:18px 16px;width:min(90vw,420px);font:600 16px system-ui;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  #card h2{margin:0 0 6px;font-size:20px}
  #row{display:flex;justify-content:space-between;margin:8px 0}
  #card button{width:100%;margin-top:8px;padding:12px;border-radius:10px;border:1px solid #5a4537;background:#2b2018;color:#ffdca8;font-weight:700}
  #shareRow{display:flex;gap:8px}
  #shareRow button{flex:1}
  small{opacity:.7;font-weight:500}
  #startScreen{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#0e0a0a;z-index:10}
  #startBtn{padding:16px 32px;border:none;border-radius:12px;background:#ffdca8;color:#241712;font:700 18px system-ui;box-shadow:0 4px 8px rgba(0,0,0,0.3)}
</style>
</head>
<body>
<div id="wrap"><canvas id="game" width="600" height="900"></canvas></div>
<div class="hud"><span id="time">50.0s</span><span id="speed">0 m/s</span><span id="combo">x1</span></div>
<div class="meter"><i id="meterFill"></i></div>

<div class="btnpad">
  <button class="tap" id="leftBtn">◀</button>
  <button class="tap" id="rightBtn">▶</button>
</div>

<!-- 결과/공유 -->
<div id="result">
  <div id="card">
    <h2>바톤터치 결과</h2>
    <div id="row"><span>평균 속도</span><span id="avgSpeed">0.0 m/s</span></div>
    <div id="row"><span>최고 속도</span><span id="maxSpeed">0.0 m/s</span></div>
    <div id="row"><span>총 거리</span><span id="distance">0 m</span></div>
    <div id="row"><span>최대 콤보</span><span id="maxCombo">x1</span></div>
    <div id="shareRow">
      <button id="invite">친구에게 이어달리기</button>
      <button id="retry">다시 달리기</button>
    </div>
    <small id="hint">* 카카오톡 공유를 쓰려면 SDK 앱키를 넣어주세요.</small>
  </div>
</div>

<!-- 시작 화면 -->
<div id="startScreen" style="position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#0e0a0a;z-index:10;">
  <button id="startBtn" style="padding:16px 32px;border:none;border-radius:12px;background:#ffdca8;color:#241712;font:700 18px system-ui;box-shadow:0 4px 8px rgba(0,0,0,0.3);">시작하기</button>
</div>

<script>
(()=>{
// ===== Canvas scaling =====
const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
const W=cvs.width,H=cvs.height;
function fit(){const s=Math.min(innerWidth/W, innerHeight/H);cvs.style.transform=`scale(${s})`;}
addEventListener('resize',fit); fit();

// ===== State =====
let timeLeft=10; // 기본 시간을 10초로 변경
let elapsed=0, worldY=0;
let speed=0, maxSpeed=0, distance=0, combo=1, maxCombo=1;
let lastSide=null, lastTapTime=0;
let buttonClicked = false; // 버튼 클릭 여부 추가
const BASE_DECAY=18;      // 초당 감속
const TAP_BOOST=20;       // 교대 성공 가속
const SAME_PENALTY=4;     // 같은 쪽 연타 보정
const RHYTHM_WINDOW=300;  // ms, 교대 인정 시간
const SPEED_MAX=700;      // 상한(px/s)
const SPEED_MIN=0;

// HUD
const hudTime=document.getElementById('time');
const hudSpeed=document.getElementById('speed');
const hudCombo=document.getElementById('combo');
const meterFill=document.getElementById('meterFill');

// tap buttons
const L=document.getElementById('leftBtn'), R=document.getElementById('rightBtn');
L.addEventListener('click',()=>tap('L'));
R.addEventListener('click',()=>tap('R'));

// Result elements
const panel=document.getElementById('result');
const avgSpeedEl=document.getElementById('avgSpeed');
const maxSpeedEl=document.getElementById('maxSpeed');
const distanceEl=document.getElementById('distance');
const maxComboEl=document.getElementById('maxCombo');
const retryBtn=document.getElementById('retry');
const inviteBtn=document.getElementById('invite');

const startScreen = document.getElementById('startScreen');
const startBtn = document.getElementById('startBtn');

retryBtn.onclick=reset;
inviteBtn.onclick = shareInvite; // '친구에게 이어달리기' 버튼에 카카오톡 공유 연결

startBtn.addEventListener('click', () => {
  startScreen.style.display = 'none'; // 시작 화면 숨기기
  running = true; // 게임 시작
  requestAnimationFrame(step); // 게임 루프 시작
});

// ===== Player (시점 고정) 그래픽 최소 =====
function drawBackground(){
  // 어두운 배경
  ctx.fillStyle = "#0f0b0a";
  ctx.fillRect(0, 0, W, H);

  // 중앙 트랙
  const pathW = W * 0.4, cx = W / 2;
  ctx.fillStyle = "#241712"; // 트랙 색상
  ctx.fillRect(cx - pathW / 2, 0, pathW, H);

  // 트랙 라인
  ctx.strokeStyle = "#ffdca8"; // 트랙 라인 색상
  ctx.lineWidth = 2;
  for (let i = 0; i < 20; i++) {
    const y = (worldY * 0.8 + i * 80) % H; // 배경 속도감 강화
    ctx.beginPath();
    ctx.moveTo(cx - pathW / 2 + 10, y);
    ctx.lineTo(cx - pathW / 2 + 10, y + 40);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(cx + pathW / 2 - 10, y);
    ctx.lineTo(cx + pathW / 2 - 10, y + 40);
    ctx.stroke();
  }

  // 개미 카메라 프레임(하단)
  drawAnt(cx, H * 0.82, 22); // 화면 정중앙에 개미 배치
}

function drawAnt(x, y, r) {
  const bounce = Math.sin(performance.now() / 100) * (speed / SPEED_MAX) * 5; // 속도에 따라 위아래로 움직임 추가
  ctx.save();
  ctx.translate(x, y + bounce); // 개미 위치에 위아래 움직임 적용

  // 몸통
  ctx.fillStyle = "#5b1f14";
  ctx.beginPath();
  ctx.ellipse(0, 0, r * 1.2, r * 0.8, 0, 0, Math.PI * 2);
  ctx.fill();

  // 머리
  ctx.beginPath();
  ctx.ellipse(-r * 0.9, 0, r * 0.6, r * 0.45, 0, 0, Math.PI * 2);
  ctx.fill();

  // 엉덩이
  ctx.beginPath();
  ctx.ellipse(r * 0.95, 0, r * 0.55, r * 0.4, 0, 0, Math.PI * 2);
  ctx.fill();

  // 다리
  ctx.strokeStyle = "#3a2316";
  ctx.lineWidth = 2;
  for (let i = -1; i <= 1; i += 2) {
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(i * r * 1.5, r * 0.8);
    ctx.stroke();
  }

  // 머리띠(하얀)
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.arc(-r * 0.9, -2, r * 0.55, Math.PI * 0.15, Math.PI * 0.85);
  ctx.stroke();

  // 바통
  ctx.strokeStyle = "#f7c04a";
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(r * 0.6, -r * 0.1);
  ctx.lineTo(r * 1.3, -r * 0.4);
  ctx.stroke();

  ctx.restore();
}

// ===== Tap logic =====
function tap(side){
  buttonClicked = true; // 버튼 클릭 시 true로 설정
  const now=performance.now();
  const alternated = (lastSide && lastSide!==side && (now-lastTapTime)<=RHYTHM_WINDOW);
  if(alternated){
    combo++; maxCombo=Math.max(maxCombo,combo);
    speed = Math.min(SPEED_MAX, speed + TAP_BOOST * (1+Math.min((combo-1)*0.05,0.5))); // 콤보 보너스 감소
    flash('#fff199', .35);
  }else{
    combo = (lastSide===side)? Math.max(1, Math.floor(combo*0.7)) : 1;
    speed = Math.min(SPEED_MAX, speed + (TAP_BOOST*0.2) - SAME_PENALTY); // 기본 증가량 감소
    flash('rgba(255,255,255,.15)', .2);
  }
  lastSide = side; lastTapTime=now;
}

let flashA=0, flashC='#fff';
function flash(c,a){flashC=c;flashA=a;}
function drawFlash(){
  if(flashA>0){ctx.save();ctx.globalAlpha=flashA;ctx.fillStyle=flashC;ctx.fillRect(0,0,W,H);ctx.restore();flashA=Math.max(0,flashA-0.03);}
}

// ===== Loop =====
let last=0, totalSpeed=0, samples=0, running=true;
function reset(){
  timeLeft=30; elapsed=0; worldY=0;
  speed=0; maxSpeed=0; distance=0; combo=1; maxCombo=1;
  lastSide=null; lastTapTime=0; totalSpeed=0; samples=0;
  running=false; panel.style.display='none';
  startScreen.style.display = 'flex'; // 시작 화면 다시 표시
}
reset();

function step(ts){
  requestAnimationFrame(step);
  if(!last) last=ts;
  const dt=Math.min((ts-last)/1000, 1/30); last=ts;

  // 시간은 계속 감소하도록 유지
  elapsed += dt; timeLeft = Math.max(0, 20 - elapsed);

  if(!running){
    drawBackground(); drawFlash();
    return;
  }

  if (buttonClicked) { // 버튼 클릭 여부 확인
    // physics
    speed = Math.max(SPEED_MIN, speed - BASE_DECAY*dt);
    maxSpeed = Math.max(maxSpeed, speed);
    distance += speed*dt; worldY += speed*dt*0.7; // 배경 위치 업데이트

    // stats
    totalSpeed += speed; samples++;

    buttonClicked = false; // 클릭 상태 초기화
  }

  // draw
  drawBackground(); drawFlash();

  // HUD
  hudTime.textContent = timeLeft.toFixed(1)+'s';
  hudSpeed.textContent = (speed/30).toFixed(1)+' m/s'; // px를 임의 변환
  hudCombo.textContent = 'x'+combo;
  const meter = Math.min(100, (speed/SPEED_MAX)*100);
  meterFill.style.width = meter+'%';

  if(timeLeft<=0){ finish(); }
}
requestAnimationFrame(step);

function finish(){
  running=false;
  // 결과 계산
  const avg = (totalSpeed/Math.max(1,samples))/30;
  const maxv = maxSpeed/30;
  document.getElementById('avgSpeed').textContent = avg.toFixed(1)+' m/s';
  document.getElementById('maxSpeed').textContent = maxv.toFixed(1)+' m/s';
  document.getElementById('distance').textContent = Math.round(distance/10)+' m';
  document.getElementById('maxCombo').textContent = 'x'+maxCombo;
  panel.style.display='grid';
}

// ===== Share (웹쉐어 + 이어달리기) =====
async function shareInvite(){
  const params = new URLSearchParams({
    relay:'1',
    best: (maxSpeed/30).toFixed(1),
    avg:  ((totalSpeed/Math.max(1,samples))/30).toFixed(1),
    distance: Math.round(distance/10),
    maxCombo: maxCombo
  });
  const shareUrl = `${location.origin}${location.pathname}?${params.toString()}`;
  const title='바톤터치 이어달리기';
  const text=`내 기록 평균 ${(totalSpeed/Math.max(1,samples)/30).toFixed(1)} m/s, 최고 ${(maxSpeed/30).toFixed(1)} m/s! 이어달려봐✨`;

  // 카카오톡 공유 바로 실행
  if(window.Kakao && window.Kakao.isInitialized?.()){
    window.Kakao.Share.sendDefault({
      objectType:'feed',
      content:{
        title, 
        description:text, 
        imageUrl:'', 
        link:{mobileWebUrl:shareUrl, webUrl:shareUrl}
      },
      buttons:[{title:'이어달리기', link:{mobileWebUrl:shareUrl, webUrl:shareUrl}}]
    });
  }else{
    alert('카카오톡 공유를 사용할 수 없습니다. SDK 초기화를 확인하세요.');
  }
}

// ===== 이어달리기 기록 불러오기 =====
function loadRelayData(){
  const params = new URLSearchParams(location.search);
  if(params.get('relay')==='1'){
    const best = parseFloat(params.get('best')) || 0;
    const avg = parseFloat(params.get('avg')) || 0;
    const dist = parseInt(params.get('distance')) || 0;
    const maxC = parseInt(params.get('maxCombo')) || 1;

    // 기존 기록을 화면에 표시
    document.getElementById('avgSpeed').textContent = avg.toFixed(1)+' m/s';
    document.getElementById('maxSpeed').textContent = best.toFixed(1)+' m/s';
    document.getElementById('distance').textContent = dist+' m';
    document.getElementById('maxCombo').textContent = 'x'+maxC;

    // 친구 기록 합산
    const currentDist = Math.round(distance / 10);
    const totalDist = dist + currentDist;
    document.getElementById('distance').textContent = totalDist + ' m';
  }
}

// ===== 초기화 =====
reset();
loadRelayData(); // 이어달리기 데이터 불러오기
})();

;(function(){
  const s=document.createElement('script');
  s.src='https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js'; s.async=true;
  s.onload=()=>{ window.Kakao.init('1de330cc79df5741ccd741f1d73f9042'); };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
